<template>
  <v-container>
    <!-- ÈùûÊâãÊ©üÊ°åÈù¢Áâà -->
    <v-row v-if="!isMobile">
      <v-col cols="12">
        <v-card elevation="2">
          <!-- Â∑•ÂÖ∑Âàó -->
          <v-toolbar flat>
            <v-btn variant="outlined" @click="openDialog(null)">Êñ∞Â¢ûË≤ºÊñá</v-btn>
            <v-spacer />
            <v-text-field
              v-model="search"
              placeholder="ÊêúÂ∞ãË≤ºÊñá"
              prepend-inner-icon="mdi-magnify"
              variant="solo"
              hide-details
              dense
              style="max-width: 300px; opacity: 0.5"
            />
            <v-select
              v-model="filterCategory"
              :items="categoryOptions"
              placeholder="ÁØ©ÈÅ∏ÂàÜÈ°û"
              clearable
              hide-details
              dense
              style="max-width: 200px"
            />
            <v-select
              v-model="filterRelease"
              :items="[
                { label: 'Â∑≤ÁôºÂ∏É', value: true },
                { label: 'Êú™ÁôºÂ∏É', value: false },
              ]"
              item-title="label"
              item-value="value"
              placeholder="ÁØ©ÈÅ∏ÁôºÂ∏É"
              clearable
              hide-details
              dense
              style="max-width: 150px"
            />
          </v-toolbar>

          <!-- Ë≥áÊñôË°® -->
          <v-data-table
            :headers="headers"
            :items="filteredProducts"
            :items-per-page="10"
            class="elevation-1"
          >
            <template #[`item.image`]="{ value }">
              <v-img
                class="clickable-image"
                :src="value"
                width="120"
                @click="showImage(value)"
              />
            </template>

            <template #[`item.description`]="{ item }">
              <span
                class="description-text"
                @click="showDescription(item.description)"
              >
                {{
                  item.description.length > 50
                    ? item.description.slice(0, 50) + "..."
                    : item.description
                }}
              </span>
            </template>

            <template #[`item.release`]="{ value }">
              <v-icon v-if="value" color="green">mdi-check-circle</v-icon>
            </template>

            <template #[`item.action`]="{ item }">
              <v-tooltip bottom>
                <template #activator="{ props }">
                  <v-btn
                    v-bind="props"
                    icon
                    color="primary"
                    @click="openDialog(item)"
                    style="width: 30px; height: 30px"
                  >
                    <v-icon size="x-small">mdi-pencil</v-icon>
                  </v-btn>
                </template>
                <span>Á∑®ËºØË≤ºÊñá</span>
              </v-tooltip>

              <v-tooltip bottom>
                <template #activator="{ props }">
                  <v-btn
                    v-bind="props"
                    icon
                    color="red"
                    @click="deleteProduct(item._id)"
                    style="width: 30px; height: 30px"
                  >
                    <v-icon size="x-small">mdi-delete</v-icon>
                  </v-btn>
                </template>
                <span>Âà™Èô§Ë≤ºÊñá</span>
              </v-tooltip>
            </template>
          </v-data-table>
        </v-card>
      </v-col>
    </v-row>

    <!-- ÊâãÊ©üÁâàÂç°ÁâáÂàóË°® -->
    <v-row v-else>
      <v-col cols="12">
        <!-- ÊâãÊ©üÁâàÂ∑•ÂÖ∑Âàó -->
        <v-card elevation="2" class="mb-4 pa-2">
          <v-btn variant="outlined" block @click="openDialog(null)"
            >Êñ∞Â¢ûË≤ºÊñá</v-btn
          >
          <v-text-field
            v-model="search"
            placeholder="ÊêúÂ∞ãË≤ºÊñá"
            prepend-inner-icon="mdi-magnify"
            variant="solo"
            hide-details
            dense
            class="mt-2"
          />
          <v-select
            v-model="filterCategory"
            :items="categoryOptions"
            placeholder="ÁØ©ÈÅ∏ÂàÜÈ°û"
            clearable
            hide-details
            dense
            class="mt-2"
          />
          <v-select
            v-model="filterRelease"
            :items="[
              { label: 'Â∑≤ÁôºÂ∏É', value: true },
              { label: 'Êú™ÁôºÂ∏É', value: false },
            ]"
            item-title="label"
            item-value="value"
            placeholder="ÁØ©ÈÅ∏ÁôºÂ∏É"
            clearable
            hide-details
            dense
            class="mt-2"
          />
        </v-card>
      </v-col>

      <v-col cols="12" v-for="item in filteredProducts" :key="item._id">
        <v-card outlined class="mb-2">
          <v-card-title>
            <v-img
              v-if="item.image"
              :src="item.image"
              max-height="150"
              cover
              class="mb-2 rounded"
              @click="showImage(item.image)"
            />
            <div class="w-full">
              <div class="card-title-ellipsis">
                <strong>{{ item.title }}</strong>
              </div>
              <div class="mt-1">
                <v-chip
                  v-for="c in item.category"
                  :key="c"
                  size="small"
                  color="primary"
                  class="ml-1"
                >
                  {{ c }}
                </v-chip>
              </div>
            </div>
          </v-card-title>

          <v-card-text>
            <div class="text-caption text-grey">
              üïí {{ new Date(item.createdAt).toLocaleString() }}
            </div>
            <div class="mt-2 text-caption text-grey">
              üìç {{ item.location }}
            </div>
            <div
              class="text-truncate-2"
              @click="showDescription(item.description)"
            >
              {{ item.description || "(Ê≤íÊúâÊñáÁ´†)" }}
            </div>
          </v-card-text>

          <v-card-actions>
            <v-spacer />
            <v-btn icon size="small" color="primary" @click="openDialog(item)">
              <v-icon>mdi-pencil</v-icon>
            </v-btn>
            <v-btn
              icon
              size="small"
              color="red"
              @click="deleteProduct(item._id)"
            >
              <v-icon>mdi-delete</v-icon>
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-col>
    </v-row>

    <!-- Êñ∞Â¢û/Á∑®ËºØ Dialog -->
    <v-dialog
      v-model="dialog.open"
      persistent
      :max-width="isMobile ? '95%' : '700'"
    >
      <v-form :disabled="isSubmitting" @submit.prevent="submit">
        <v-card>
          <v-card-title>{{ dialog.id ? "Á∑®ËºØË≤ºÊñá" : "Êñ∞Â¢ûË≤ºÊñá" }}</v-card-title>
          <v-card-text>
            <v-row dense>
              <v-col cols="12" md="6">
                <v-text-field
                  v-model="title.value.value"
                  :error-messages="title.errorMessage.value"
                  label="Ê®ôÈ°å"
                />
              </v-col>
              <v-col cols="12" md="6">
                <v-select
                  v-model="category.value.value"
                  :items="categoryOptions"
                  :error-messages="category.errorMessage.value"
                  label="ÂàÜÈ°û"
                  multiple
                  chips
                />
              </v-col>
              <v-col cols="12" md="6">
                <v-text-field
                  v-model="location.value.value"
                  :error-messages="location.errorMessage.value"
                  label="‰ΩçÁΩÆ"
                />
              </v-col>
              <v-col cols="12" md="6">
                <v-switch
                  color="green"
                  v-model="release.value.value"
                  label="ÁôºÂ∏É"
                />
              </v-col>
              <v-col cols="12">
                <v-textarea
                  v-model="description.value.value"
                  :error-messages="description.errorMessage.value"
                  label="ÊñáÁ´†"
                />
              </v-col>
              <v-col cols="12">
                <VueFileAgent
                  ref="fileAgent"
                  v-model="fileRecords"
                  v-model:raw-model-value="rawFileRecords"
                  accept="image/jpeg,image/png"
                  deletable
                  :error-text="{
                    type: 'Ê™îÊ°àÊ†ºÂºè‰∏çÊ≠£Á¢∫',
                    size: 'Ê™îÊ°àÂ§ßÂ∞è‰∏çÂæóË∂ÖÈÅé 5MB',
                  }"
                  help-text="ÈÅ∏ÊìáÊàñÊãñÊãΩÊ™îÊ°à"
                  max-size="5MB"
                />
              </v-col>
            </v-row>
          </v-card-text>
          <v-card-actions>
            <v-spacer />
            <v-btn color="red" :disabled="isSubmitting" @click="closeDialog"
              >ÂèñÊ∂à</v-btn
            >
            <v-btn color="green" :loading="isSubmitting" type="submit">
              {{ dialog.id ? "Á∑®ËºØ" : "Êñ∞Â¢û" }}
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-form>
    </v-dialog>

    <!-- ÂúñÁâáÊîæÂ§ß Dialog -->
    <v-dialog v-model="imageDialog.open" max-width="800">
      <v-card>
        <v-img :src="imageDialog.src" />
        <v-card-actions>
          <v-spacer />
          <v-btn color="primary" text @click="imageDialog.open = false"
            >ÈóúÈñâ</v-btn
          >
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- ÊñáÁ´†ÊèèËø∞ÂÖßÂÆπ Dialog -->
    <v-dialog v-model="descDialog.open" max-width="500">
      <v-card>
        <v-card-title>ÊñáÁ´†ÂÖßÂÆπ</v-card-title>
        <v-card-text>
          <pre style="white-space: pre-wrap">{{ descDialog.text }}</pre>
        </v-card-text>
        <v-card-actions>
          <v-spacer />
          <v-btn color="primary" text @click="descDialog.open = false"
            >ÈóúÈñâ</v-btn
          >
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-container>
</template>

<script setup>
import { ref, computed } from "vue";
import { useField, useForm } from "vee-validate";
import * as yup from "yup";
import { useSnackbar } from "vuetify-use-dialog";
import productService from "@/services/article";
import { useDisplay } from "vuetify"; // üîë Âà§Êñ∑Ëû¢ÂπïÂ§ßÂ∞è

const { smAndDown } = useDisplay();
const isMobile = computed(() => smAndDown.value);
const filterRelease = ref(null);

const createSnackbar = useSnackbar();

const products = ref([]);
const search = ref("");

const headers = [
  { title: "ID", key: "_id" },
  { title: "ÂúñÁâá", key: "image", sortable: false },
  { title: "Ê®ôÈ°å", key: "title" },
  { title: "ÊñáÁ´†", key: "description" },
  { title: "‰ΩçÁΩÆ", key: "location" },
  {
    title: "ÂàÜÈ°û",
    key: "category",
    value: (item) =>
      Array.isArray(item.category)
        ? item.category.filter((c) => c && c.trim() !== "").join(", ")
        : item.category || "",
  },
  { title: "ÁôºÂ∏É", key: "release" },
  {
    title: "Âª∫Á´ãÊó•Êúü",
    key: "createdAt",
    value: (item) => new Date(item.createdAt).toLocaleString(),
  },
  {
    title: "Êõ¥Êñ∞Êó•Êúü",
    key: "updatedAt",
    value: (item) => new Date(item.updatedAt).toLocaleString(),
  },
  { title: "Êìç‰Ωú", key: "action", sortable: false },
];

const filteredProducts = computed(() => {
  let result = products.value;

  if (search.value) {
    const keyword = search.value.toLowerCase();
    result = result.filter((p) =>
      [p._id, p.title, p.category, p.description, p.location].some((field) =>
        String(field || "")
          .toLowerCase()
          .includes(keyword)
      )
    );
  }

  if (filterCategory.value) {
    result = result.filter((p) => p.category.includes(filterCategory.value));
  }

  if (filterRelease.value !== null) {
    result = result.filter((p) => p.release === filterRelease.value);
  }

  return result;
});

async function getProducts() {
  try {
    const { data } = await productService.getUser();
    products.value = data.articles;
  } catch (error) {
    createSnackbar({
      text: "ÁÑ°Ê≥ïËºâÂÖ•Ë≤ºÊñáË≥áÊñô",
      snackbarProps: { color: "red" },
    });
  }
}
getProducts();

const fileAgent = ref(null);
const dialog = ref({ open: false, id: "" });

const categoryOptions = [
  "ÊôÇ‰∫ã",
  "ÁæéÈ£ü",
  "ÊúçË£ù",
  "ÂÆ∂Â±ÖÁî®ÂìÅ",
  "Â®õÊ®Ç",
  "Áé©ÂÖ∑",
  "È£üÂìÅ",
  "ÂØµÁâ©",
  "Èü≥Ê®Ç",
  "ÈÅãÂãï",
  "ÂÖ∂‰ªñ",
];

const { handleSubmit, resetForm, isSubmitting } = useForm({
  validationSchema: yup.object({
    title: yup
      .string()
      .required("Ê®ôÈ°åÊòØÂøÖÂ°´ÁöÑ")
      .max(100, "Ê®ôÈ°åÊúÄÂ§ö 100 ÂÄãÂ≠óÂÖÉ"),
    category: yup
      .array()
      .of(yup.string().oneOf(categoryOptions))
      .min(1, "Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÂàÜÈ°û"),
    description: yup.string().max(1000, "ÊñáÁ´†ÊúÄÂ§ö 1000 ÂÄãÂ≠óÂÖÉ"),
    location: yup
      .string()
      .required("‰ΩçÁΩÆÊòØÂøÖÂ°´ÁöÑ")
      .max(100, "‰ΩçÁΩÆÊúÄÂ§ö 100 ÂÄãÂ≠óÂÖÉ"),
    release: yup.boolean().oneOf([true, false], "ÂøÖÈ†àÈÅ∏ÊìáÊòØÂê¶ÁôºÂ∏É"),
  }),
  initialValues: {
    title: "",
    category: [],
    description: "",
    location: "",
    release: false,
  },
});

const title = useField("title");
const category = useField("category");
const description = useField("description");
const location = useField("location");
const release = useField("release");

const fileRecords = ref([]);
const filterCategory = ref(null);

const rawFileRecords = ref(null);

function openDialog(item) {
  if (item) {
    dialog.value.id = item._id;
    title.value.value = item.title;
    category.value.value = Array.isArray(item.category)
      ? item.category
      : [item.category];
    description.value.value = item.description;
    location.value.value = item.location;
    release.value.value = item.release;
  } else {
    dialog.value.id = "";
    resetForm();
    fileRecords.value = [];
    rawFileRecords.value = [];
    fileAgent.value?.deleteAllFileRecords?.();
  }
  dialog.value.open = true;
}

function closeDialog() {
  dialog.value.open = false;
  dialog.value.id = "";
  resetForm();
  fileAgent.value?.deleteAllFileRecords?.();
}

const submit = handleSubmit(async (values) => {
  if (fileRecords.value[0]?.error) {
    createSnackbar({
      text: "Ë´ãÈÅ∏ÊìáÊúâÊïàÁöÑÂúñÁâáÊ™îÊ°à",
      snackbarProps: { color: "red" },
    });
    return;
  }
  if (!dialog.value.id && fileRecords.value.length === 0) {
    createSnackbar({ text: "Ë´ã‰∏äÂÇ≥Ë≤ºÊñáÂúñÁâá", snackbarProps: { color: "red" } });
    return;
  }

  try {
    const fd = new FormData();
    fd.append("title", values.title);
    fd.append("category", JSON.stringify(values.category));
    fd.append("description", values.description || "");
    fd.append("location", values.location);
    fd.append("release", String(values.release));

    if (fileRecords.value.length > 0) {
      fd.append("image", fileRecords.value[0].file);
    }

    if (!dialog.value.id) {
      await productService.create(fd);
    } else {
      await productService.update(dialog.value.id, fd);
    }

    createSnackbar({ text: "Êìç‰ΩúÊàêÂäüÔºÅ", snackbarProps: { color: "green" } });
    closeDialog();
    getProducts();
  } catch (error) {
    createSnackbar({
      text: error?.response?.data?.message || "Êìç‰ΩúÂ§±Êïó",
      snackbarProps: { color: "red" },
    });
  }
});

async function deleteProduct(id) {
  if (!confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁØáË≤ºÊñáÂóéÔºü")) return;
  try {
    await productService.remove(id);
    createSnackbar({ text: "Âà™Èô§ÊàêÂäüÔºÅ", snackbarProps: { color: "green" } });
    getProducts();
  } catch (error) {
    createSnackbar({
      text: "Âà™Èô§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶",
      snackbarProps: { color: "red" },
    });
  }
}

const imageDialog = ref({ open: false, src: "" });
function showImage(src) {
  imageDialog.value.src = src;
  imageDialog.value.open = true;
}

const descDialog = ref({ open: false, text: "" });
function showDescription(text) {
  descDialog.value.text = text || "(Ê≤íÊúâÊñáÁ´†)";
  descDialog.value.open = true;
}
</script>

<style scoped>
.clickable-image {
  cursor: pointer;
}
.description-text {
  cursor: pointer;
  color: #1976d2;
  text-decoration: underline;
}
.v-data-table tbody tr:hover {
  background-color: #f5f5f5;
}
.text-truncate-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2; /* ÈôêÂà∂ 2 Ë°å */
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.card-title-ellipsis {
  font-weight: bold;
  font-size: 1.1rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 90vw; /* Êàñ 200px, ‰æùÈúÄÊ±ÇË™øÊï¥ */
  display: block;
}
</style>

<route lang="yaml">
meta:
  layout: "admin"
  title: "Ë≤ºÊñáÁÆ°ÁêÜ"
  login: "login-only"
  admin: false
</route>
