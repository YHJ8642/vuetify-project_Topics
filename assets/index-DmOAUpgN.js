import{ad as Ke,p as fe,v as me,l as De,O as Ne,R as pe,I as qe,ae as We,af as Xe,ag as Ye,L as Ge,ah as He,ai as Je,M as Qe,aj as Ze,ak as et,e as l,al as tt,d as f,am as Q,an as ve,ab as V,n as ke,a5 as xe,j as h,ao as at,W as lt,X as ze,Y as ot,ap as nt,aq as st,_ as rt,ar as it,as as ut,a1 as Fe,at as ct,m as dt,au as le,av as mt,aw as vt,a9 as ft,a8 as gt,a as yt,r as v,y as _t,z as pt,b as kt,c as _,o as c,w as o,f as I,ax as xt,ay as Ce,a7 as be,aa as w,k as d,F as oe,i as Ve,az as Y,aA as ne,t as p,aB as Ct,aC as se,a4 as he,aD as G,g as re,aE as ie,h as ue}from"./index-BHqT0DJ1.js";import{p as we}from"./article-CNltXJVT.js";import{f as H}from"./favorite-DUJBpBmV.js";import{b as Se}from"./route-block-B_A1xBdJ.js";import{V as Pe,a as ce}from"./VRow-BeTpeMM3.js";import{V as Ae}from"./VSelect-DFxscRf0.js";import{V as Ie}from"./VList-J2nK02R2.js";import{V as Le,a as bt,b as Vt}from"./VListItem-CE6wf30l.js";import{V as ht}from"./VDivider-Dj08CXfC.js";import{V as wt}from"./VBadge-CcM3YHN_.js";import{V as St}from"./VTextarea-DgKfi4WU.js";import{V as Pt}from"./VContainer-DA4u5_Ny.js";import"./ssrBoot-CcqnvGWo.js";const At=Ke("v-alert-title"),It=fe({iconSize:[Number,String],iconSizes:{type:Array,default:()=>[["x-small",10],["small",16],["default",24],["large",28],["x-large",32]]}},"iconSize");function Lt(a,u){return{iconSize:me(()=>{const s=new Map(a.iconSizes),m=a.iconSize??u()??"default";return s.has(m)?s.get(m):m})}}const Dt=["success","info","warning","error"],zt=fe({border:{type:[Boolean,String],validator:a=>typeof a=="boolean"||["top","end","bottom","start"].includes(a)},borderColor:String,closable:Boolean,closeIcon:{type:ct,default:"$close"},closeLabel:{type:String,default:"$vuetify.close"},icon:{type:[Boolean,String,Function,Object],default:null},modelValue:{type:Boolean,default:!0},prominent:Boolean,title:String,text:String,type:{type:String,validator:a=>Dt.includes(a)},...Fe(),...ut(),...it(),...rt(),...It(),...st(),...nt(),...ot(),...ze(),...lt(),...at({variant:"flat"})},"VAlert"),Ft=De()({name:"VAlert",props:zt(),emits:{"click:close":a=>!0,"update:modelValue":a=>!0},setup(a,u){let{emit:r,slots:s}=u;const m=Ne(a,"modelValue"),k=pe(()=>{if(a.icon!==!1)return a.type?a.icon??`$${a.type}`:a.icon}),{iconSize:L}=Lt(a,()=>a.prominent?44:28),{themeClasses:P}=qe(a),{colorClasses:D,colorStyles:Z,variantClasses:M}=We(()=>({color:a.color??a.type,variant:a.variant})),{densityClasses:R}=Xe(a),{dimensionStyles:z}=Ye(a),{elevationClasses:b}=Ge(a),{locationStyles:F}=He(a),{positionClasses:A}=Je(a),{roundedClasses:T}=Qe(a),{textColorClasses:U,textColorStyles:$}=Ze(()=>a.borderColor),{t:B}=et(),x=pe(()=>({"aria-label":B(a.closeLabel),onClick(y){m.value=!1,r("click:close",y)}}));return()=>{const y=!!(s.prepend||k.value),S=!!(s.title||a.title),j=!!(s.close||a.closable),E={density:a.density,icon:k.value,size:L.value};return m.value&&l(a.tag,{class:ve(["v-alert",a.border&&{"v-alert--border":!!a.border,[`v-alert--border-${a.border===!0?"start":a.border}`]:!0},{"v-alert--prominent":a.prominent},P.value,D.value,R.value,b.value,A.value,T.value,M.value,a.class]),style:Q([Z.value,z.value,F.value,a.style]),role:"alert"},{default:()=>{var K,N;return[tt(!1,"v-alert"),a.border&&f("div",{key:"border",class:ve(["v-alert__border",U.value]),style:Q($.value)},null),y&&f("div",{key:"prepend",class:"v-alert__prepend"},[s.prepend?l(xe,{key:"prepend-defaults",disabled:!k.value,defaults:{VIcon:{...E}}},s.prepend):l(V,ke({key:"prepend-icon"},E),null)]),f("div",{class:"v-alert__content"},[S&&l(At,{key:"title"},{default:()=>{var C;return[((C=s.title)==null?void 0:C.call(s))??a.title]}}),((K=s.text)==null?void 0:K.call(s))??a.text,(N=s.default)==null?void 0:N.call(s)]),s.append&&f("div",{key:"append",class:"v-alert__append"},[s.append()]),j&&f("div",{key:"close",class:"v-alert__close"},[s.close?l(xe,{key:"close-defaults",defaults:{VBtn:{icon:a.closeIcon,size:"x-small",variant:"text"}}},{default:()=>{var C;return[(C=s.close)==null?void 0:C.call(s,{props:x.value})]}}):l(h,ke({key:"close-btn",icon:a.closeIcon,size:"x-small",variant:"text"},x.value),null)])]}})}}}),Tt=fe({start:Boolean,end:Boolean,...Fe(),...ze()},"VListItemAction"),$t=De()({name:"VListItemAction",props:Tt(),setup(a,u){let{slots:r}=u;return dt(()=>l(a.tag,{class:ve(["v-list-item-action",{"v-list-item-action--start":a.start,"v-list-item-action--end":a.end},a.class]),style:Q(a.style)},r)),{}}}),J={getComments(a){return le.api.get(`/articles/${a}/comments`)},addComment(a,u){return le.apiAuth.post(`/articles/${a}/comments`,u)},deleteComment(a,u){return le.apiAuth.delete(`/articles/${a}/comments/${u}`)}},Bt=mt("favorite",{state:()=>({favorites:[]}),actions:{async fetchFavorites(){try{const{data:a}=await H.getAll();this.favorites=a.favorites||[]}catch(a){console.error("取得收藏失敗:",a),this.favorites=[]}},async toggleFavorite(a){const u=this.favorites.find(r=>{var s;return((s=r.post)==null?void 0:s._id)===a._id});if(console.log("toggleFavorite 開始:",{postId:a._id,favObj:u,currentFavorites:this.favorites.length}),u)console.log("移除收藏:",u._id),await H.remove(u._id),this.favorites=this.favorites.filter(r=>r._id!==u._id),console.log("移除後的收藏數量:",this.favorites.length);else{console.log("添加收藏:",a._id);const{data:r}=await H.add(a._id);console.log("新增收藏回應:",r.favorite),this.favorites.push(r.favorite),console.log("添加後的收藏數量:",this.favorites.length)}this.favorites=[...this.favorites]},async removeFavorite(a){await H.remove(a),this.favorites=this.favorites.filter(u=>u._id!==a)},isFavorite(a){return this.favorites.some(u=>{var r;return((r=u.post)==null?void 0:r._id)===a})}}}),Ot={key:0,class:"loading-overlay"},Mt={key:1,style:{position:"relative"}},Rt={class:"font-weight-bold"},Ut={class:"text-caption grey--text"},jt={class:"text-body-2 pa-4"},Et={key:0,class:"comment-list"},Kt={class:"text-caption grey--text",style:{"margin-left":"8px"}},Nt={key:1,class:"text-center grey--text"},de=6,Te={__name:"index",setup(a){const u=ft(),r=gt(),s=Bt(),m=yt(),k=v([]),L=v(""),P=v("全部"),D=v("commentCount_desc"),Z=["時事","美食","服裝","家居用品","娛樂","玩具","食品","寵物","音樂","運動","其他"],M=[{text:"最熱門話題",key:"commentCount_desc",sortKey:"commentCount",direction:-1},{text:"最新貼文",key:"createdAt_desc",sortKey:"createdAt",direction:-1},{text:"最舊貼文",key:"createdAt_asc",sortKey:"createdAt",direction:1},{text:"名稱",key:"title_asc",sortKey:"title",direction:1}],R=async n=>{n.clickCount=(n.clickCount||0)+1;try{await we.update(n._id,{clickCount:n.clickCount})}catch(e){console.error("更新點擊數失敗",e)}},z=v(de),b=v(!0),F=v(!1),A=v(null),T=v(!1),U=v(null),$=v({}),B=v(!1),x=v(null),y=v([]),S=v(""),j=async n=>{x.value=n,B.value=!0;try{const{data:e}=await J.getComments(n._id);y.value=(e.comments||[]).sort((i,t)=>new Date(t.createdAt)-new Date(i.createdAt)),n.commentCount=y.value.length}catch(e){console.error(e),r({text:"無法取得留言",snackbarProps:{color:"red"}})}},E=()=>{B.value=!1,x.value=null,S.value="",y.value=[]},K=async()=>{if(!S.value.trim())return r({text:"請輸入留言內容",snackbarProps:{color:"orange"}});if(!m.isLoggedIn){r({text:"請先登入才能留言",snackbarProps:{color:"orange"}}),u.push("/login");return}try{await J.addComment(x.value._id,{content:S.value}),r({text:"留言已送出",snackbarProps:{color:"green"}});const{data:n}=await J.getComments(x.value._id);y.value=(n.comments||[]).sort((i,t)=>new Date(t.createdAt)-new Date(i.createdAt)),S.value="";const e=k.value.findIndex(i=>i._id===x.value._id);e!==-1&&(k.value[e].commentCount=y.value.length),ee()}catch(n){console.error(n),r({text:"留言失敗",snackbarProps:{color:"red"}})}},N=async(n,e)=>{if(!m.isLoggedIn){r({text:"請先登入才能刪除留言",snackbarProps:{color:"orange"}}),u.push("/login");return}try{await J.deleteComment(x.value._id,n._id),y.value.splice(e,1);const i=k.value.findIndex(t=>t._id===x.value._id);i!==-1&&(k.value[i].commentCount=y.value.length),ee(),r({text:"留言已刪除",snackbarProps:{color:"green"}})}catch(i){console.error(i),r({text:"刪除留言失敗",snackbarProps:{color:"red"}})}},C=v([]),ee=()=>{C.value=k.value.slice().sort((n,e)=>e.commentCount-n.commentCount).slice(0,3).map(n=>n._id)},$e=n=>n?n.length<=100?n:n.slice(0,100)+"...":"",Be=n=>{A.value=n,F.value=!0},Oe=()=>{F.value=!1,A.value=null},Me=n=>{U.value=n,T.value=!0},q=me(()=>{const n=M.find(e=>e.key===D.value);return k.value.filter(e=>{var O,ae,_e;const i=L.value.toLowerCase(),t=((O=e.title)==null?void 0:O.toLowerCase().includes(i))||((_e=(ae=e.user)==null?void 0:ae.account)==null?void 0:_e.toLowerCase().includes(i)),g=P.value!=="全部"?Array.isArray(e.category)&&e.category.includes(P.value):!0;return t&&g}).sort((e,i)=>{if(!n)return 0;const{sortKey:t,direction:g}=n;return["createdAt","updatedAt"].includes(t)?g>0?new Date(e[t])-new Date(i[t]):new Date(i[t])-new Date(e[t]):g>0?e[t]>i[t]?1:-1:e[t]<i[t]?1:-1})}),W=me(()=>q.value.slice(0,z.value)),Re=async()=>{try{b.value=!0;const{data:n}=await we.get();k.value=n.articles.map(e=>({...e,commentCount:e.commentCount||0})),ee()}catch(n){console.error(n),r({text:"無法載入貼文資料",snackbarProps:{color:"red"}})}finally{b.value=!1}},ge=n=>s.isFavorite(n),Ue=async n=>{if(!m.isLoggedIn){r({text:"請先登入才能使用收藏功能",snackbarProps:{color:"orange"}}),u.push("/login");return}if(!$.value[n._id]){$.value[n._id]=!0;try{await s.toggleFavorite(n);const e=s.isFavorite(n._id);r({text:e?"已加入收藏":"已移除收藏",snackbarProps:{color:e?"green":"blue"}}),m.setFavorites(Array.isArray(s.favorites)?s.favorites.length:0)}catch(e){console.error(e),r({text:"收藏操作失敗",snackbarProps:{color:"red"}})}finally{$.value[n._id]=!1}}},te=v(null);let ye=null;const je=()=>{ye=new IntersectionObserver(n=>{n[0].isIntersecting&&!b.value&&z.value<q.value.length&&(b.value=!0,setTimeout(()=>{z.value+=de,b.value=!1},500))},{rootMargin:"0px 0px 200px 0px"}),te.value&&ye.observe(te.value)},X=()=>{z.value=Math.min(de,q.value.length)},Ee=n=>{if(!n)return"#e0e0e0";let e=0;for(let i=0;i<n.length;i++)e=n.charCodeAt(i)+((e<<5)-e);return`hsl(${e%360},60%,85%)`};return _t(async()=>{await Re(),m.isLoggedIn?(await s.fetchFavorites(),m.setFavorites(Array.isArray(s.favorites)?s.favorites.length:0)):m.setFavorites(0),je()}),pt([L,P,D],X),(n,e)=>{const i=kt("v-list-item-content");return c(),_(Pt,null,{default:o(()=>[l(Pe,{align:"center",class:"mb-4",justify:"space-between"},{default:o(()=>[l(ce,{cols:"12",md:"6",class:"search-container",style:{"padding-right":"25px"}},{default:o(()=>[l(xt,{modelValue:L.value,"onUpdate:modelValue":[e[0]||(e[0]=t=>L.value=t),X],density:"comfortable",flat:"","hide-details":"",placeholder:"搜尋貼文","prepend-inner-icon":"mdi-magnify",variant:"solo"},null,8,["modelValue"])]),_:1}),l(ce,{class:"d-flex justify-end align-center",cols:"12",md:"6",style:{"padding-right":"25px"}},{default:o(()=>[l(Ae,{modelValue:P.value,"onUpdate:modelValue":[e[1]||(e[1]=t=>P.value=t),X],density:"comfortable",items:["全部",...Z],variant:"outlined","hide-details":"",style:{"background-color":"white",height:"49px",opacity:"0.7","box-shadow":"0 2px 5px rgba(0, 0, 0, 0.2)"}},null,8,["modelValue","items"]),l(Ae,{modelValue:D.value,"onUpdate:modelValue":[e[2]||(e[2]=t=>D.value=t),X],class:"ml-2",density:"comfortable","item-title":"text","item-value":"key",items:M,variant:"outlined","hide-details":"",style:{"background-color":"white",height:"49px",opacity:"0.7","box-shadow":"0 2px 5px rgba(0, 0, 0, 0.2)"}},null,8,["modelValue"])]),_:1})]),_:1}),b.value&&W.value.length===0?(c(),I("div",Ot,[l(Ce,{color:"primary",indeterminate:"",size:"48"})])):(c(),I("div",Mt,[l(be,{name:"fade"},{default:o(()=>[q.value.length===0&&!b.value?(c(),_(Ft,{key:0,border:"start",class:"mb-6",color:"teal",prominent:"",style:{width:"100%"},type:"info",variant:"tonal"},{default:o(()=>[l(V,{start:""},{default:o(()=>e[8]||(e[8]=[d("mdi-information-outline",-1)])),_:1,__:[8]}),e[9]||(e[9]=d(" 沒有符合條件的貼文 ",-1))]),_:1,__:[9]})):w("",!0)]),_:1}),l(be,{name:"fade"},{default:o(()=>[W.value.length>0?(c(),_(Pe,{key:0,style:{width:"100%"}},{default:o(()=>[(c(!0),I(oe,null,Ve(W.value,t=>(c(),_(ce,{key:t._id,cols:"12",md:"6",lg:"4"},{default:o(()=>[l(Y,{class:"pa-0",elevation:"2",style:{position:"relative"}},{default:o(()=>[C.value.includes(t._id)?(c(),I(oe,{key:0},[C.value.indexOf(t._id)===0?(c(),_(V,{key:0,color:"#FFD700",size:"50",style:{position:"absolute",top:"8px",right:"8px"},class:"mdi-crown"},{default:o(()=>e[10]||(e[10]=[d("mdi-crown",-1)])),_:1,__:[10]})):w("",!0),C.value.indexOf(t._id)===1?(c(),_(V,{key:1,color:"#C0C0C0",size:"50",style:{position:"absolute",top:"8px",right:"8px"},class:"mdi-crown silver"},{default:o(()=>e[11]||(e[11]=[d("mdi-crown",-1)])),_:1,__:[11]})):w("",!0),C.value.indexOf(t._id)===2?(c(),_(V,{key:2,color:"#B87333",size:"50",style:{position:"absolute",top:"8px",right:"8px"},class:"mdi-crown bronze"},{default:o(()=>e[12]||(e[12]=[d("mdi-crown",-1)])),_:1,__:[12]})):w("",!0)],64)):w("",!0),l(ne,{class:"d-flex align-center"},{default:o(()=>[l(Ie,null,{default:o(()=>[l(Le,{"prepend-avatar":`https://api.dicebear.com/9.x/thumbs/png/seed=${t.user.account}`},null,8,["prepend-avatar"])]),_:2},1024),f("div",null,[f("div",Rt,p(t.user.account||"匿名用戶"),1),f("div",Ut,p(new Date(t.createdAt).toLocaleString()),1)])]),_:2},1024),l(Ct,{onClick:g=>{Be(t),R(t)},class:"text-h6",style:{cursor:"pointer",color:"#26a69a"}},{default:o(()=>[d(p(t.title),1)]),_:2},1032,["onClick"]),l(se,{class:"pa-0"},{default:o(()=>[t.image?(c(),_(he,{key:0,class:"post-image",cover:"",src:t.image,style:{cursor:"zoom-in"},onClick:g=>{Me(t.image),R(t)}},null,8,["src","onClick"])):w("",!0),f("div",jt,p($e(t.content)),1)]),_:2},1024),l(ht),l(G,null,{default:o(()=>[l(h,{icon:"",loading:$.value[t._id],onClick:g=>Ue(t)},{default:o(()=>[l(V,{color:re(m).isLoggedIn&&ge(t._id)?"red":void 0},{default:o(()=>[d(p(re(m).isLoggedIn&&ge(t._id)?"mdi-heart":"mdi-heart-outline"),1)]),_:2},1032,["color"])]),_:2},1032,["loading","onClick"]),t.commentCount>0?(c(),_(wt,{key:0,content:t.commentCount,color:"primary",overlap:"",bordered:""},{default:o(()=>[l(h,{icon:"",onClick:g=>j(t)},{default:o(()=>[l(V,null,{default:o(()=>e[13]||(e[13]=[d("mdi-comment-outline",-1)])),_:1,__:[13]})]),_:2},1032,["onClick"])]),_:2},1032,["content"])):(c(),_(h,{key:1,icon:"",onClick:g=>j(t)},{default:o(()=>[l(V,null,{default:o(()=>e[14]||(e[14]=[d("mdi-comment-outline",-1)])),_:1,__:[14]})]),_:2},1032,["onClick"])),l(h,{icon:""},{default:o(()=>[l(V,null,{default:o(()=>e[15]||(e[15]=[d("mdi-share-outline",-1)])),_:1,__:[15]})]),_:1})]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})):w("",!0)]),_:1})])),f("div",{ref_key:"loadMoreTrigger",ref:te,class:"text-center py-4"},[b.value&&W.value.length>0?(c(),_(Ce,{key:0,color:"primary",indeterminate:""})):w("",!0)],512),l(ie,{modelValue:F.value,"onUpdate:modelValue":e[3]||(e[3]=t=>F.value=t),"max-width":"500px"},{default:o(()=>[l(Y,null,{default:o(()=>[l(ne,{class:"headline title-wrap"},{default:o(()=>{var t;return[d(p((t=A.value)==null?void 0:t.title),1)]}),_:1}),l(se,null,{default:o(()=>{var t,g;return[f("div",null,[e[16]||(e[16]=f("strong",null,"來源:",-1)),d(" "+p(((t=A.value)==null?void 0:t.location)||"無來源資訊"),1)]),f("div",null,[e[17]||(e[17]=f("strong",null,"文章:",-1)),f("div",null,p(((g=A.value)==null?void 0:g.description)||"無描述"),1)])]}),_:1}),l(G,null,{default:o(()=>[l(ue),l(h,{color:"primary",text:"",onClick:Oe},{default:o(()=>e[18]||(e[18]=[d("關閉",-1)])),_:1,__:[18]})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ie,{modelValue:T.value,"onUpdate:modelValue":e[5]||(e[5]=t=>T.value=t),"max-width":"800px"},{default:o(()=>[l(Y,null,{default:o(()=>[l(he,{class:"w-100",cover:"",src:U.value},null,8,["src"]),l(G,null,{default:o(()=>[l(ue),l(h,{color:"primary",text:"",onClick:e[4]||(e[4]=t=>T.value=!1)},{default:o(()=>e[19]||(e[19]=[d("關閉",-1)])),_:1,__:[19]})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ie,{modelValue:B.value,"onUpdate:modelValue":e[7]||(e[7]=t=>B.value=t),"max-width":"500px"},{default:o(()=>[l(Y,null,{default:o(()=>[l(ne,{class:"headline"},{default:o(()=>{var t;return[d(p((t=x.value)==null?void 0:t.title)+" 的留言",1)]}),_:1}),l(se,null,{default:o(()=>[y.value.length?(c(),I("div",Et,[l(Ie,null,{default:o(()=>[(c(!0),I(oe,null,Ve(y.value,(t,g)=>(c(),_(Le,{"prepend-avatar":`https://api.dicebear.com/9.x/thumbs/png/seed=${t.user.account||"anonymous"}`,key:g,style:Q({backgroundColor:Ee(t.user.account),padding:"8px",borderRadius:"8px",marginBottom:"4px"})},{default:o(()=>{var O;return[l(i,null,{default:o(()=>[l(bt,{class:"font-weight-bold"},{default:o(()=>[d(p(t.user.account||"匿名用戶")+" ",1),f("span",Kt,p(new Date(t.createdAt).toLocaleString()),1)]),_:2},1024),l(Vt,null,{default:o(()=>[d(p(t.content),1)]),_:2},1024)]),_:2},1024),((O=re(m))==null?void 0:O.account)===t.user.account?(c(),_($t,{key:0,class:"ml-auto d-flex align-center justify-end",style:{"min-width":"auto",padding:"0"}},{default:o(()=>[l(h,{onClick:ae=>N(t,g),style:{padding:"0","min-width":"auto",height:"auto",background:"transparent",border:"none"}},{default:o(()=>[l(V,{size:"25",color:"red"},{default:o(()=>e[20]||(e[20]=[d("mdi-delete",-1)])),_:1,__:[20]})]),_:2},1032,["onClick"])]),_:2},1024)):w("",!0)]}),_:2},1032,["prepend-avatar","style"]))),128))]),_:1})])):(c(),I("div",Nt,"目前沒有留言")),l(St,{modelValue:S.value,"onUpdate:modelValue":e[6]||(e[6]=t=>S.value=t),label:"新增留言",rows:"1","auto-grow":"",class:"mt-4"},null,8,["modelValue"])]),_:1}),l(G,null,{default:o(()=>[l(ue),l(h,{color:"primary",text:"",onClick:E},{default:o(()=>e[21]||(e[21]=[d("關閉",-1)])),_:1,__:[21]}),l(h,{color:"primary",onClick:K},{default:o(()=>e[22]||(e[22]=[d("送出",-1)])),_:1,__:[22]})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}}};typeof Se=="function"&&Se(Te);const oa=vt(Te,[["__scopeId","data-v-a90788e2"]]);export{oa as default};
